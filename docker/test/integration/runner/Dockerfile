# docker build -t clickhouse/integration-tests-runner .
FROM ubuntu:22.04

# ARG for quick switch to a given ubuntu mirror
ARG apt_archive="http://archive.ubuntu.com"

RUN sed -i "s|http://archive.ubuntu.com|$apt_archive|g" /etc/apt/sources.list

RUN apt-get update \
    && env DEBIAN_FRONTEND=noninteractive apt-get install --yes \
    adduser='3.118*' \
    ca-certificates='20230311ubuntu0.22.04.*' \
    bash='5.1*' \
    btrfs-progs='5.16.*' \
    e2fsprogs='1.46.*' \
    iptables='1.8.*' \
    xfsprogs='5.13.*' \
    tar='1.34*' \
    pigz='2.6*' \
    wget='1.21.*' \
    git='1:2.34*' \
    iproute2='5.15.*' \
    cgroupfs-mount='1.4*' \
    python3-pip='22.0.*' \
    tzdata='2023c-0ubuntu0.22.04*' \
    libicu-dev='70.1*' \
    bsdutils='1:2.37.*' \
    curl='7.81.*' \
    python3-pika='1.2.*' \
    liblua5.1-dev \
    luajit='2.1.*' \
    libssl-dev='3.0.*' \
    libcurl4-openssl-dev='7.81.*' \
    gdb='12.1*' \
    default-jdk='2:1.11*' \
    software-properties-common='0.99.*' \
    libkrb5-dev='1.19.*' \
    krb5-user='1.19.*' \
    g++='4:11.*' \
    && rm -rf \
        /var/lib/apt/lists/* \
        /var/cache/debconf \
        /tmp/* \
    && apt-get clean

ENV TZ=Etc/UTC
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

ENV DOCKER_CHANNEL stable
# Unpin the docker version after the release 24.0.3 is released
# https://github.com/moby/moby/issues/45770#issuecomment-1618255130
RUN curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add - \
    && add-apt-repository "deb https://download.docker.com/linux/ubuntu $(lsb_release -c -s) ${DOCKER_CHANNEL}" \
    && apt-get update \
    && env DEBIAN_FRONTEND=noninteractive apt-get install --yes \
        docker-ce='5:23.*' \
    && rm -rf \
        /var/lib/apt/lists/* \
        /var/cache/debconf \
        /tmp/* \
    && apt-get clean \
    && dockerd --version; docker --version


RUN python3 -m pip install --no-cache-dir \
    PyMySQL=='1.1.*' \
    aerospike=='11.1.*' \
    asyncio=='3.4.*'\
    avro=='1.10.*' \
    azure-storage-blob=='12.19.*'\
    cassandra-driver=='3.28.*'\
    confluent-kafka=='1.9.*' \
    delta-spark=='2.3.*' \
    dict2xml=='1.7.*' \
    dicttoxml=='1.7.*' \
    docker=='6.1.*' \
    docker-compose=='1.29.*' \
    grpcio=='1.59.*' \
    grpcio-tools=='1.59.*' \
    kafka-python=='2.0.*' \
    kazoo=='2.9.*' \
    lz4=='4.3.*' \
    meilisearch=='0.18.*' \
    minio=='7.2.*' \
    nats-py=='2.6.*' \
    protobuf=='4.25.*' \
    psycopg2-binary=='2.9.*' \
    pyhdfs=='0.3.*' \
    pymongo=='3.11.*' \
    pyspark=='3.3.*' \
    pytest=='7.4.*' \
    pytest-order=='1.0.*' \
    pytest-random==0.2 \
    pytest-repeat=='0.9.*' \
    pytest-timeout=='2.2.*' \
    pytest-xdist=='3.5.*' \
    pytz=='2023.3.*' \
    pyyaml=='5.3.*' \
    redis=='5.0.*' \
    requests-kerberos \
    tzlocal==2.1 \
    retry=='0.9.*' \
    bs4=='0.0.*' \
    lxml=='4.9.*' \
    urllib3=='2.1.*'
# bs4, lxml are for cloud tests, do not delete

# Hudi supports only spark 3.3.*, not 3.4
RUN curl -fsSL -O https://archive.apache.org/dist/spark/spark-3.3.2/spark-3.3.2-bin-hadoop3.tgz \
    && tar xzvf spark-3.3.2-bin-hadoop3.tgz -C / \
    && rm spark-3.3.2-bin-hadoop3.tgz

# download spark and packages
# if you change packages, don't forget to update them in tests/integration/helpers/cluster.py
RUN packages="org.apache.hudi:hudi-spark3.3-bundle_2.12:0.13.0,\
io.delta:delta-core_2.12:2.3.0,\
org.apache.iceberg:iceberg-spark-runtime-3.3_2.12:1.1.0" \
    && /spark-3.3.2-bin-hadoop3/bin/spark-shell --packages "$packages" > /dev/null \
    && find /root/.ivy2/ -name '*.jar' -exec ln -sf {} /spark-3.3.2-bin-hadoop3/jars/ \;

RUN set -x \
  && addgroup --system dockremap \
  && adduser --system dockremap \
  && adduser dockremap dockremap \
  && echo 'dockremap:165536:65536' >> /etc/subuid \
  && echo 'dockremap:165536:65536' >> /etc/subgid

COPY modprobe.sh /usr/local/bin/modprobe
COPY dockerd-entrypoint.sh /usr/local/bin/
COPY compose/ /compose/
COPY misc/ /misc/


# Same options as in test/base/Dockerfile
# (in case you need to override them in tests)
ENV TSAN_OPTIONS='halt_on_error=1 abort_on_error=1 history_size=7 memory_limit_mb=46080 second_deadlock_stack=1'
ENV UBSAN_OPTIONS='print_stacktrace=1'
ENV MSAN_OPTIONS='abort_on_error=1 poison_in_dtor=1'

EXPOSE 2375
ENTRYPOINT ["dockerd-entrypoint.sh"]
# To pass additional arguments (i.e. list of tests) use PYTEST_ADDOPTS
CMD ["sh", "-c", "pytest"]
