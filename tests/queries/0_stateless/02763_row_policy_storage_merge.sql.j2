DROP TABLE IF EXISTS 02763_merge_log_1;
DROP TABLE IF EXISTS 02763_merge_log_2;
DROP TABLE IF EXISTS 02763_merge_merge_1;
DROP TABLE IF EXISTS 02763_merge_merge_2;
DROP ROW POLICY IF EXISTS 02763_filter_1 ON 02763_merge_log_1;
DROP ROW POLICY IF EXISTS 02763_filter_2 ON 02763_merge_merge_1;


CREATE TABLE 02763_merge_log_1 (x UInt8) ENGINE = Log;
CREATE TABLE 02763_merge_log_2 (x UInt8) ENGINE = Log;

CREATE TABLE 02763_merge_merge_1 (x UInt8) ENGINE = MergeTree ORDER BY x;
CREATE TABLE 02763_merge_merge_2 (x UInt8) ENGINE = MergeTree ORDER BY x;

INSERT INTO 02763_merge_log_1 VALUES (1), (2), (3), (4);
INSERT INTO 02763_merge_log_2 VALUES (1), (2), (3), (4);
INSERT INTO 02763_merge_merge_1 VALUES (1), (2), (3), (4);
INSERT INTO 02763_merge_merge_2 VALUES (1), (2), (3), (4);

SELECT * FROM merge(currentDatabase(), '02763_merge') ORDER BY x;

SELECT * FROM 02763_merge_log_1 ORDER BY x;


{% for prew in [0 , 1] -%}

SELECT 'SETTINGS optimize_move_to_prewhere= {{prew}}';

CREATE ROW POLICY 02763_filter_1 ON 02763_merge_log_1 USING x=3 AS permissive TO ALL;

SELECT 'SELECT * FROM 02763_merge_log_1';
SELECT * FROM 02763_merge_log_1 ORDER BY x SETTINGS optimize_move_to_prewhere= {{prew}};
SELECT 'SELECT * FROM merge(currentDatabase(), 02763_merge_log_1)';
SELECT * FROM merge(currentDatabase(), '02763_merge_log_1') ORDER BY x SETTINGS optimize_move_to_prewhere= {{prew}};;
SELECT 'SELECT * FROM merge(currentDatabase(), 02763_merge_log)';
SELECT * FROM merge(currentDatabase(), '02763_merge_log') ORDER BY x SETTINGS optimize_move_to_prewhere= {{prew}};;
SELECT 'SELECT * FROM merge(currentDatabase(), 02763_merge_log) WHERE x>2';
SELECT * FROM merge(currentDatabase(), '02763_merge_log') WHERE x>2 ORDER BY x SETTINGS optimize_move_to_prewhere= {{prew}};;

CREATE ROW POLICY 02763_filter_2 ON 02763_merge_merge_1 USING x=4 AS permissive TO ALL;

SELECT 'SELECT * FROM 02763_merge_merge_1';
SELECT * FROM 02763_merge_merge_1 ORDER BY x SETTINGS optimize_move_to_prewhere= {{prew}};;
SELECT 'SELECT * FROM merge(currentDatabase(), 02763_merge_merge_1';
SELECT * FROM merge(currentDatabase(), '02763_merge_merge_1') ORDER BY x SETTINGS optimize_move_to_prewhere= {{prew}};;
SELECT 'SELECT * FROM merge(currentDatabase(), 02763_merge_merge)';
SELECT * FROM merge(currentDatabase(), '02763_merge_merge') ORDER BY x SETTINGS optimize_move_to_prewhere= {{prew}};;
SELECT 'SELECT * FROM merge(currentDatabase(), 02763_merge_merge) WHERE x>2';
SELECT * FROM merge(currentDatabase(), '02763_merge_merge') WHERE x>2 ORDER BY x SETTINGS optimize_move_to_prewhere= {{prew}};;


SELECT 'SELECT * FROM merge(currentDatabase(), 02763_merge)';
SELECT * FROM merge(currentDatabase(), '02763_merge') ORDER BY x SETTINGS optimize_move_to_prewhere= {{prew}};;
SELECT 'SELECT * FROM merge(currentDatabase(), 02763_merge) WHEER x>2';
SELECT * FROM merge(currentDatabase(), '02763_merge') WHERE x>2 ORDER BY x SETTINGS optimize_move_to_prewhere= {{prew}};;

DROP ROW POLICY 02763_filter_1 ON 02763_merge_log_1;
DROP ROW POLICY 02763_filter_2 ON 02763_merge_merge_1;

{% endfor %}
