name: ReleaseBranchCI

env:
  # Force the stdout and stderr streams to be unbuffered
  PYTHONUNBUFFERED: 1
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  REGRESSION_RESULTS_URL: altinity-build-artifacts/${{github.event.number}}/$GITHUB_SHA


on: # yamllint disable-line rule:truthy
  pull_request:
    types:
      - synchronize
      - reopened
      - opened
    branches:
      # Anything/23.3 (e.g customizations/23.3)
      - '**/23.3*'
  release:
    types:
      - published
      - prereleased
  push:
    branches:
      - 'releases/23.3**'

jobs:
  x86-app:
    runs-on: [self-hosted, on-demand, type-cpx21, image-x86-app-docker-ce]
    steps:
      - name: Check out repository code
        uses: ClickHouse/checkout@v1
      - name: Check
        run: |
          free -h
      - name: Setup docker IPv6
        run: |
          sudo touch /etc/docker/daemon.json
          sudo chown ubuntu:ubuntu /etc/docker/daemon.json
          sudo cat <<EOT > /etc/docker/daemon.json
            {
               "ipv6": true,
               "fixed-cidr-v6": "2001:db8:1::/64",
               "insecure-registries" : ["dockerhub-proxy.dockerhub-proxy-zone:5000"],
               "registry-mirrors" : ["http://dockerhub-proxy.dockerhub-proxy-zone:5000"]
            }
          EOT
          sudo chown root:root /etc/docker/daemon.json
          sudo systemctl restart docker
  arm-app:
    runs-on: [self-hosted, on-demand, type-cax21, in-fsn1, image-arm-app-docker-ce]
    steps:
      - name: Check out repository code
        uses: ClickHouse/checkout@v1
      - name: Check
        run: |
          free -h
      - name: Setup docker IPv6
        run: |
          sudo touch /etc/docker/daemon.json
          sudo chown ubuntu:ubuntu /etc/docker/daemon.json
          sudo cat <<EOT > /etc/docker/daemon.json
            {
               "ipv6": true,
               "fixed-cidr-v6": "2001:db8:1::/64",
               "insecure-registries" : ["dockerhub-proxy.dockerhub-proxy-zone:5000"],
               "registry-mirrors" : ["http://dockerhub-proxy.dockerhub-proxy-zone:5000"]
            }
          EOT
          sudo chown root:root /etc/docker/daemon.json
          sudo systemctl restart docker
  # x86-snap:
  #   runs-on: [self-hosted, image-x86-snapshot-docker_ipv6_x86, on-demand, type-cpx51]
  #   steps:
  #     - name: Check out repository code
  #       uses: ClickHouse/checkout@v1
  #     - name: Check
  #       run: |
  #         free -h
  # arm-snap:
  #   runs-on: [self-hosted, on-demand, type-cax41, image-arm-snapshot-docker_ipv6_arm]
  #   steps:
  #     - name: Check out repository code
  #       uses: ClickHouse/checkout@v1
  #     - name: Check
  #       run: |
  #         free -h


